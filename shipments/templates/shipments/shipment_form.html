{% extends 'base.html' %}

{% block title %}{% if object %}Editar Envío{% else %}Nuevo Envío{% endif %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <div>
        <a href="{% url 'shipment-list' %}" class="text-blue-600 hover:text-blue-800 text-sm">&larr; Volver a la lista</a>
        <h2 class="text-3xl font-bold text-gray-900 mt-2">
            {% if object %}Editar Envío{% else %}Nuevo Envío{% endif %}
        </h2>
    </div>

    <form method="post" class="bg-white rounded-lg shadow-md p-6 space-y-6">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <!-- Sección de Referencia Interna -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-medium text-blue-900 mb-3">Referencia Interna</h3>
            {% if object %}
            <p class="text-sm text-gray-600 mb-3">
                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                La referencia interna no se puede modificar una vez creado el despacho.
            </p>
            {% endif %}
            <div class="flex flex-wrap items-end gap-2">
                <div class="flex items-center">
                    <span class="px-3 py-2 bg-blue-600 text-white font-bold rounded-l-md">LC</span>
                    <div>
                        <label for="{{ form.ref_initials.id_for_label }}" class="sr-only">Iniciales</label>
                        {{ form.ref_initials }}
                    </div>
                </div>
                <div>
                    <label for="{{ form.ref_consecutive.id_for_label }}" class="sr-only">Consecutivo</label>
                    {{ form.ref_consecutive }}
                </div>
                <span class="px-2 py-2 text-gray-600 font-bold">/</span>
                <div>
                    <input type="text" id="year_suffix" readonly value="{% if object %}{{ object.reference|slice:'-2:' }}{% else %}{% now 'y' %}{% endif %}"
                           class="w-12 py-2 px-2 bg-gray-100 border border-gray-300 rounded-md text-center font-mono">
                </div>
                <span class="text-gray-500">=</span>
                <div class="flex-1 min-w-[150px]">
                    <input type="text" id="reference_preview" readonly
                           class="w-full py-2 px-3 bg-green-50 border border-green-300 rounded-md font-mono font-bold text-green-800"
                           value="{% if object %}{{ object.reference }}{% endif %}"
                           placeholder="LC__0001/26">
                </div>
                {% if not object %}
                <button type="button" id="suggest-consecutive"
                        class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Sugerir
                </button>
                {% endif %}
            </div>
            {% if form.ref_initials.errors %}
            <p class="mt-1 text-sm text-red-600">Iniciales: {{ form.ref_initials.errors.0 }}</p>
            {% endif %}
            {% if form.ref_consecutive.errors %}
            <p class="mt-1 text-sm text-red-600">Consecutivo: {{ form.ref_consecutive.errors.0 }}</p>
            {% endif %}
            {% if not object %}
            <p class="mt-2 text-sm text-blue-700">
                Formato: <strong>LC</strong> + <strong>2 letras</strong> + <strong>consecutivo (4 dígitos)</strong> + <strong>/</strong> + <strong>año</strong>
                <br>Ejemplo: LCMJ0005/26
            </p>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for field in form %}
            {% if field.name != 'ref_initials' and field.name != 'ref_consecutive' %}
            <div class="{% if field.name == 'notes' %}md:col-span-2{% endif %}">
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">
                    {{ field.label }}
                    {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                </label>
                {{ field }}
                {% if field.errors %}
                <p class="mt-1 text-sm text-red-600">{{ field.errors.0 }}</p>
                {% endif %}
                {% if field.help_text %}
                <p class="mt-1 text-sm text-gray-500">{{ field.help_text }}</p>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Contenedores -->
        <div class="border-t pt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Contenedores</h3>
                <button type="button" id="add-container" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Agregar
                </button>
            </div>

            {{ container_formset.management_form }}

            <div id="container-formset" class="space-y-3">
                {% for container_form in container_formset %}
                <div class="container-row flex items-end gap-3 p-3 bg-gray-50 rounded-lg {% if container_form.instance.pk %}{% else %}{% if forloop.last and not container_form.instance.pk %}empty-form-template{% endif %}{% endif %}">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">{{ container_form.number.label }}</label>
                        {{ container_form.number }}
                        {% if container_form.number.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ container_form.number.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">{{ container_form.size.label }}</label>
                        {{ container_form.size }}
                        {% if container_form.size.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ container_form.size.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="hidden">
                        {{ container_form.id }}
                        {{ container_form.DELETE }}
                    </div>
                    <button type="button" class="remove-container px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg flex items-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
                {% endfor %}
            </div>

            <p class="mt-2 text-sm text-gray-500" id="no-containers-msg" style="display: none;">No hay contenedores agregados.</p>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
            <a href="{% url 'shipment-list' %}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                Cancelar
            </a>
            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                {% if object %}Actualizar{% else %}Crear{% endif %} Envío
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== REFERENCIA INTERNA =====
    const refInitials = document.getElementById('id_ref_initials');
    const refConsecutive = document.getElementById('id_ref_consecutive');
    const yearSuffix = document.getElementById('year_suffix');
    const referencePreview = document.getElementById('reference_preview');
    const suggestBtn = document.getElementById('suggest-consecutive');
    const isEditing = {% if object %}true{% else %}false{% endif %};

    function updateReferencePreview() {
        const initials = (refInitials.value || '__').toUpperCase().padEnd(2, '_').substring(0, 2);
        const consecutive = (refConsecutive.value || '0000').padStart(4, '0');
        const year = yearSuffix.value;
        referencePreview.value = `LC${initials}${consecutive}/${year}`;
    }

    // Solo agregar eventos de edición si NO es edición (nuevo despacho)
    if (!isEditing) {
        // Convertir iniciales a mayúsculas y actualizar preview
        refInitials.addEventListener('input', function() {
            this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '');
            updateReferencePreview();
        });

        // Formatear consecutivo y actualizar preview
        refConsecutive.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            updateReferencePreview();
        });

        // Al perder foco, rellenar con ceros
        refConsecutive.addEventListener('blur', function() {
            if (this.value) {
                this.value = this.value.padStart(4, '0');
                updateReferencePreview();
            }
        });

        // Botón sugerir consecutivo
        if (suggestBtn) {
            suggestBtn.addEventListener('click', function() {
                fetch('{% url "shipment-next-consecutive" %}')
                    .then(response => response.json())
                    .then(data => {
                        refConsecutive.value = data.consecutive;
                        updateReferencePreview();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al obtener el consecutivo sugerido');
                    });
            });

            // Si es nuevo, sugerir consecutivo automáticamente
            suggestBtn.click();
        }

        // Inicializar preview solo para nuevos
        updateReferencePreview();
    }

    // ===== CONTENEDORES =====
    const formsetContainer = document.getElementById('container-formset');
    const addButton = document.getElementById('add-container');
    const totalFormsInput = document.querySelector('[name="container_set-TOTAL_FORMS"]');
    const noContainersMsg = document.getElementById('no-containers-msg');

    // Template for new container row
    function getEmptyFormHtml(index) {
        return `
            <div class="container-row flex items-end gap-3 p-3 bg-gray-50 rounded-lg">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700"># Contenedor</label>
                    <input type="text" name="container_set-${index}-number" maxlength="50"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                           placeholder="Ej: EITU9568530" id="id_container_set-${index}-number">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700">Tamaño</label>
                    <input type="text" name="container_set-${index}-size" maxlength="20"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                           placeholder="Ej: 40HC" id="id_container_set-${index}-size">
                </div>
                <div class="hidden">
                    <input type="hidden" name="container_set-${index}-id" id="id_container_set-${index}-id">
                </div>
                <button type="button" class="remove-container px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg flex items-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;
    }

    function updateNoContainersMessage() {
        const visibleRows = formsetContainer.querySelectorAll('.container-row:not([style*="display: none"])');
        noContainersMsg.style.display = visibleRows.length === 0 ? 'block' : 'none';
    }

    // Add new container
    addButton.addEventListener('click', function() {
        const currentTotal = parseInt(totalFormsInput.value);
        const newFormHtml = getEmptyFormHtml(currentTotal);
        formsetContainer.insertAdjacentHTML('beforeend', newFormHtml);
        totalFormsInput.value = currentTotal + 1;
        updateNoContainersMessage();
    });

    // Remove container (using event delegation)
    formsetContainer.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-container');
        if (removeBtn) {
            const row = removeBtn.closest('.container-row');
            const deleteInput = row.querySelector('input[name$="-DELETE"]');
            const idInput = row.querySelector('input[name$="-id"]');

            if (idInput && idInput.value) {
                // Existing container - mark for deletion
                if (deleteInput) {
                    deleteInput.checked = true;
                }
                row.style.display = 'none';
            } else {
                // New container - just remove the row
                row.remove();
            }
            updateNoContainersMessage();
        }
    });

    // Initial check
    updateNoContainersMessage();
});
</script>
{% endblock %}
