{% extends 'base.html' %}

{% block title %}Estadisticas por Departamento{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-gray-900">Estadisticas por Departamento</h2>
            <p class="text-sm text-gray-500">Analisis de rendimiento por departamento - {{ current_year }}</p>
        </div>
        <a href="{% url 'department-list' %}" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Volver a Departamentos
        </a>
    </div>

    {% if department_stats %}
    <!-- Tarjetas de departamentos -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for stat in department_stats %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 border-b" style="border-left: 4px solid {{ stat.department.color }}">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">{{ stat.department.name }}</h3>
                    {% if stat.department.code %}
                    <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded">{{ stat.department.code }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs text-gray-500">Usuarios</p>
                        <p class="text-xl font-bold text-gray-900">{{ stat.users_count }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Pasos</p>
                        <p class="text-xl font-bold text-gray-900">{{ stat.steps_count }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Embarques</p>
                        <p class="text-xl font-bold text-blue-600">{{ stat.shipments_count }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Trackings Completados</p>
                        <p class="text-xl font-bold text-green-600">{{ stat.trackings_completed }}</p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-500">Tiempo promedio:</span>
                        <span class="font-semibold {% if stat.avg_response_hours > 0 %}text-amber-600{% else %}text-gray-400{% endif %}">
                            {% if stat.avg_response_hours > 0 %}
                                {{ stat.avg_response_hours }} hrs
                            {% else %}
                                Sin datos
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between items-center text-sm mt-2">
                        <span class="text-gray-500">Pendientes:</span>
                        <span class="font-semibold {% if stat.trackings_pending > 0 %}text-amber-600{% else %}text-gray-400{% endif %}">
                            {{ stat.trackings_pending }}
                        </span>
                    </div>
                    <div class="flex justify-between items-center text-sm mt-2">
                        <span class="text-gray-500">En progreso:</span>
                        <span class="font-semibold {% if stat.trackings_in_progress > 0 %}text-blue-600{% else %}text-gray-400{% endif %}">
                            {{ stat.trackings_in_progress }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Graficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Embarques por Departamento -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Embarques por Departamento</h3>
            <div class="h-64">
                <canvas id="shipmentsChart"></canvas>
            </div>
        </div>

        <!-- Trackings Completados -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Trackings Completados</h3>
            <div class="h-64">
                <canvas id="completedChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tiempo de Respuesta -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Tiempo Promedio de Respuesta (horas)</h3>
        <div class="h-64">
            <canvas id="responseTimeChart"></canvas>
        </div>
    </div>

    <!-- Tendencia Mensual -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Tendencia Mensual de Embarques por Departamento</h3>
        <div class="h-80">
            <canvas id="monthlyTrendChart"></canvas>
        </div>
    </div>

    <!-- Tabla Resumen -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Resumen Comparativo</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departamento</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Usuarios</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Embarques</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">IMP</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">EXP</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Completados</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pendientes</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tiempo Prom.</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for stat in department_stats %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full mr-3" style="background-color: {{ stat.department.color }}"></span>
                                <span class="text-sm font-medium text-gray-900">{{ stat.department.name }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">{{ stat.users_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-semibold text-blue-600">{{ stat.shipments_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-green-600">{{ stat.shipments_imp }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-purple-600">{{ stat.shipments_exp }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-emerald-600">{{ stat.trackings_completed }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-amber-600">{{ stat.trackings_pending }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">
                            {% if stat.avg_response_hours > 0 %}{{ stat.avg_response_hours }} hrs{% else %}-{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% else %}
    <!-- Sin departamentos -->
    <div class="bg-white rounded-lg shadow-md p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
        </svg>
        <p class="mt-4 text-lg text-gray-600">No hay departamentos activos</p>
        <p class="mt-2 text-sm text-gray-500">Crea departamentos y asigna usuarios para ver estadisticas.</p>
        <a href="{% url 'department-create' %}" class="mt-4 inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors">
            Crear Departamento
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if department_stats %}
<script>
    const deptNames = {{ dept_names|safe }};
    const deptColors = {{ dept_colors|safe }};
    const shipmentsData = {{ shipments_data|safe }};
    const completedData = {{ completed_data|safe }};
    const responseTimes = {{ response_times|safe }};
    const monthsLabels = {{ months_labels|safe }};
    const monthlyByDept = {{ monthly_by_dept|safe }};

    // Grafico de Embarques por Departamento
    const shipmentsCtx = document.getElementById('shipmentsChart').getContext('2d');
    new Chart(shipmentsCtx, {
        type: 'bar',
        data: {
            labels: deptNames,
            datasets: [{
                label: 'Embarques',
                data: shipmentsData,
                backgroundColor: deptColors,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });

    // Grafico de Trackings Completados
    const completedCtx = document.getElementById('completedChart').getContext('2d');
    new Chart(completedCtx, {
        type: 'doughnut',
        data: {
            labels: deptNames,
            datasets: [{
                data: completedData,
                backgroundColor: deptColors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Grafico de Tiempo de Respuesta
    const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
    new Chart(responseTimeCtx, {
        type: 'bar',
        data: {
            labels: deptNames,
            datasets: [{
                label: 'Horas promedio',
                data: responseTimes,
                backgroundColor: deptColors.map(c => c + '80'),
                borderColor: deptColors,
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' hrs';
                        }
                    }
                }
            }
        }
    });

    // Grafico de Tendencia Mensual
    const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
    const datasets = [];
    let colorIndex = 0;
    for (const [deptName, data] of Object.entries(monthlyByDept)) {
        datasets.push({
            label: deptName,
            data: data,
            borderColor: deptColors[colorIndex] || '#6366F1',
            backgroundColor: (deptColors[colorIndex] || '#6366F1') + '20',
            borderWidth: 2,
            tension: 0.4,
            fill: true
        });
        colorIndex++;
    }

    new Chart(monthlyTrendCtx, {
        type: 'line',
        data: {
            labels: monthsLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}
