{% extends 'base.html' %}

{% block title %}Configurar Pasos - {{ client.company }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <a href="{% url 'client-detail' client.pk %}" class="text-indigo-600 hover:text-indigo-800 text-sm mb-2 inline-block">&larr; Volver al cliente</a>
            <h1 class="text-2xl font-bold text-gray-900">Configurar Proceso del Cliente</h1>
            <p class="text-sm text-gray-500">{{ client.company }}</p>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-500">{{ assigned_count }} de {{ total_steps }} pasos activos</span>
        </div>
    </div>

    <!-- Acciones rapidas -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Asignacion Rapida</h3>
        <div class="flex flex-wrap gap-2">
            <form method="post" action="{% url 'client-steps-bulk' client.pk %}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="type" value="imp">
                <button type="submit" class="px-3 py-1.5 text-sm bg-green-100 hover:bg-green-200 text-green-800 rounded-md transition-colors">
                    Asignar pasos de Importacion
                </button>
            </form>
            <form method="post" action="{% url 'client-steps-bulk' client.pk %}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="type" value="exp">
                <button type="submit" class="px-3 py-1.5 text-sm bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-md transition-colors">
                    Asignar pasos de Exportacion
                </button>
            </form>
            <form method="post" action="{% url 'client-steps-bulk' client.pk %}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="type" value="all">
                <button type="submit" class="px-3 py-1.5 text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-800 rounded-md transition-colors">
                    Asignar todos los pasos
                </button>
            </form>
            <form method="post" action="{% url 'client-steps-bulk' client.pk %}" class="inline" onsubmit="return confirm('Esto removera todos los pasos opcionales. Los pasos obligatorios se mantendran. Continuar?')">
                {% csrf_token %}
                <input type="hidden" name="type" value="none">
                <button type="submit" class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition-colors">
                    Remover opcionales
                </button>
            </form>
        </div>
    </div>

    <!-- Proceso Personalizado -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
            <h3 class="text-lg font-semibold text-gray-800">Proceso Personalizado</h3>
            <p class="text-sm text-gray-500">Arrastra los pasos para reordenar. Los pasos obligatorios no se pueden mover.</p>
        </div>

        <div class="divide-y divide-gray-200">
            <!-- Paso Fijo Inicial -->
            {% if fixed_first %}
            <div class="px-6 py-4 bg-green-50 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white text-sm font-bold mr-4">
                            {{ fixed_first.number }}
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ fixed_first.description }}</p>
                            <p class="text-xs text-green-600">Paso obligatorio - Siempre primero</p>
                        </div>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                        Bloqueado
                    </span>
                </div>
            </div>
            {% endif %}

            <!-- Zona Draggable - Pasos Seleccionados -->
            <div id="selected-steps" class="min-h-[100px] bg-gray-50">
                {% if selected_steps %}
                    {% for item in selected_steps %}
                    <div class="step-item px-6 py-4 bg-white border-b border-gray-100 cursor-move hover:bg-indigo-50 transition-colors"
                         data-step-id="{{ item.step.id }}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <!-- Drag Handle -->
                                <div class="drag-handle mr-3 text-gray-400 hover:text-gray-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                                    </svg>
                                </div>
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 text-sm font-bold mr-3">
                                    {{ item.step.number }}
                                </span>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ item.step.description }}</p>
                                    <div class="flex items-center space-x-2 mt-0.5">
                                        {% if item.step.imp %}
                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">IMP</span>
                                        {% endif %}
                                        {% if item.step.exp %}
                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">EXP</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <button type="button"
                                    onclick="removeStep({{ client.pk }}, {{ item.step.id }}, this)"
                                    class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition-colors"
                                    title="Remover paso">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div id="empty-placeholder" class="px-6 py-8 text-center text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <p>Agrega pasos desde el panel de abajo</p>
                    </div>
                {% endif %}
            </div>

            <!-- Paso Fijo Final -->
            {% if fixed_last %}
            <div class="px-6 py-4 bg-amber-50 border-l-4 border-amber-500">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-amber-500 text-white text-sm font-bold mr-4">
                            {{ fixed_last.number }}
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ fixed_last.description }}</p>
                            <p class="text-xs text-amber-600">Paso obligatorio - Siempre ultimo</p>
                        </div>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                        Bloqueado
                    </span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pasos Disponibles -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Pasos Disponibles</h3>
                    <p class="text-sm text-gray-500">Click en + para agregar al proceso</p>
                </div>
                <div class="flex items-center space-x-4 text-xs text-gray-500">
                    <span class="flex items-center">
                        <span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span> Importacion
                    </span>
                    <span class="flex items-center">
                        <span class="w-3 h-3 bg-purple-500 rounded-full mr-1"></span> Exportacion
                    </span>
                </div>
            </div>
        </div>

        <div id="available-steps" class="divide-y divide-gray-200">
            {% for step in available_steps %}
            <div class="available-step px-6 py-3 hover:bg-gray-50 transition-colors" data-step-id="{{ step.id }}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-gray-600 text-sm font-bold mr-3">
                            {{ step.number }}
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-700">{{ step.description }}</p>
                            <div class="flex items-center space-x-2 mt-0.5">
                                {% if step.imp %}
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">IMP</span>
                                {% endif %}
                                {% if step.exp %}
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">EXP</span>
                                {% endif %}
                                {% if step.etapa %}
                                <span class="text-xs text-gray-400">Etapa {{ step.etapa }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <button type="button"
                            onclick="addStep({{ client.pk }}, {{ step.id }}, this)"
                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition-colors"
                            title="Agregar paso">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="px-6 py-8 text-center text-gray-400">
                <p>Todos los pasos disponibles ya han sido agregados</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Toast de notificacion -->
<div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div class="px-4 py-3 rounded-lg shadow-lg" id="toastContent">
        <p id="toastMessage" class="text-sm font-medium"></p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
const clientId = {{ client.pk }};
const csrfToken = '{{ csrf_token }}';

// Inicializar Sortable para drag & drop
document.addEventListener('DOMContentLoaded', function() {
    const selectedSteps = document.getElementById('selected-steps');

    new Sortable(selectedSteps, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'bg-indigo-100',
        chosenClass: 'bg-indigo-50',
        dragClass: 'shadow-lg',
        onEnd: function(evt) {
            saveOrder();
        }
    });
});

// Guardar orden despues de arrastrar
async function saveOrder() {
    const items = document.querySelectorAll('#selected-steps .step-item');
    const stepIds = Array.from(items).map(item => parseInt(item.dataset.stepId));

    if (stepIds.length === 0) return;

    try {
        const response = await fetch(`/clients/${clientId}/steps/reorder/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ step_ids: stepIds })
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Orden guardado', 'success');
        } else {
            showToast(data.error || 'Error al guardar orden', 'error');
        }
    } catch (error) {
        showToast('Error de conexion', 'error');
    }
}

// Agregar paso desde disponibles
async function addStep(clientId, stepId, button) {
    try {
        const response = await fetch(`/clients/${clientId}/steps/${stepId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        });

        const data = await response.json();

        if (response.ok && data.action === 'added') {
            // Recargar pagina para actualizar listas
            location.reload();
        } else {
            showToast(data.error || 'Error al agregar', 'error');
        }
    } catch (error) {
        showToast('Error de conexion', 'error');
    }
}

// Remover paso de seleccionados
async function removeStep(clientId, stepId, button) {
    try {
        const response = await fetch(`/clients/${clientId}/steps/${stepId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        });

        const data = await response.json();

        if (response.ok && data.action === 'removed') {
            // Recargar pagina para actualizar listas
            location.reload();
        } else {
            showToast(data.error || 'Error al remover', 'error');
        }
    } catch (error) {
        showToast('Error de conexion', 'error');
    }
}

function showToast(message, type) {
    const toast = document.getElementById('toast');
    const toastContent = document.getElementById('toastContent');
    const toastMessage = document.getElementById('toastMessage');

    toastMessage.textContent = message;

    if (type === 'success') {
        toastContent.className = 'px-4 py-3 rounded-lg shadow-lg bg-green-500 text-white';
    } else {
        toastContent.className = 'px-4 py-3 rounded-lg shadow-lg bg-red-500 text-white';
    }

    toast.classList.remove('hidden');

    setTimeout(() => {
        toast.classList.add('hidden');
    }, 2000);
}
</script>
{% endblock %}
